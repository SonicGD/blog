+++
title = 'Home Assistant: Начало'
date = 2024-07-17T23:10:28+05:00
+++

![Home Assistant](/ha/ha-logo.png)

Несколько лет назад мы начали делать наш дом чуть более умным. Сначала появились лампочки, которыми можно было управлять с телефона. Затем Алиса, ставшая центром управления. 
Добавились датчики освещения и умные розетки. А так же сценарии автоматизации всего этого хозяйства.

Но в один прекрасный день, а точнее ночь в доме на несколько часов пропал интернет. И оказалось что мы не можем даже свет полностью выключить.

Пришла пора что-то менять.

<!--more-->

# Нужна автономность

Как можно понять - основной проблемой является то, что все мозги нашего "умного" дома находятся где-то далеко. Причём даже в нескольких местах - Алиса на серверах Яндекса, лампочи Yeelight где-то в Китае, светодиодная лента TP-Link - вообще неизвестно где. Как только между домой и этими серверами пропадает свять - пиши пропало. Более того, иногда что-то ломается на стыке участников обработки команд и вот уже Алиса не может включить люстру. Редко, но бывает.

Очевидный выход из это ситуации это перенести все мозги внутрь дома и сделать его автономным. Существует немало систем, которые позволяют такое сделать. Однако многие из них являются проприетарными, а идти на vendor lock как-то не хочется. Или вот недавно, к примеру, Алиса научилась управлять определёнными устройствами даже без интернета. Но и список устройство ограничен, и список команд тоже.

Но не всё так плохо. Есть открытые системы, которые позволяют реализовать задуманное. Самая известная из них это, конечно же, Home Assistant. HA можно задеплоить на разные ОС, он умеет работать с кучей устройств и протоколов, а также его возможности можно расширять как с помощью официальных и не очень аддонов. Выглядело хорошо, надо было пробовать. Но сначала поговорим про поддержку устройств.

# Великий зоопарк

Устройства для умного дома могут работать по различным протоколам. Основная часть того, что есть у нас дома работает через Wi-Fi и требует подключения к интернету. Схема вглядит примерно так - с помощью приложения мы каким-то образом передаём устройству настройки подключения, оно коннектится к какому-то серверу производителя и слушает от него команды, которые мы ему можем послать через приложение или интеграцию с той же Алисой. Некоторые устройства позволяют приложению ходить к ним по локальной сети, но у нас таких немного. И если заглянуть в мониторинго трафика, то видно что каждая лампочка считаем своим долгом регулярно что-то там отправить на сервер.

К счастью, существуют альтернативные протоколы, работающие по локальной сети, а то и вовсе без Wi-Fi - это Zigbee, Z-Wave, Matter. Устройств с Z-Wave на нашем рынке я видел не особо много, но они есть. А вот Zigbee же куда более популярен и его поддерживают многие поставщики устройств. Если кратко, то вот чем отличается Zigbee от Wi-Fi:

1. Zigbee не только транспорт, но и протокол. Все устройства общаются на одном языке.
1. Устройства подключаются к какому-то локальному хабу. Устройства от разных вендоров можно подключать к одному хабу.
1. Почти все устройства являются ещё и ретранслятором сигнала, а значит не нужно обеспечивать покрытие хабом все площади квартиры.
1. Требует довольно low-power железа, устройства могут работать от обычной 2032 батарейки годами.
1. Не требуется интернет, даже для первоначального подключения.
1. Довольно вменяемая скорость, можно даже прошивки свежие заливать.

Несколько лет назад Яндекс представил собственный Zigbee-хаб в виде Яндекс.Станции 2. Вместе с ней у нас появилось несколько устройств от Aqara - розетка, датчик движения/освещения и кнопка, так что какое-то знакомство со стандартом уже было. Датчик, как примеру, поселился у входной двери и научился приветственно включать свет.

В последнее время же начинает набирать популярность стандарт Matter, который призван стать универсальным стандартом, которые заменит все остальные. 

![Стандарты](https://imgs.xkcd.com/comics/standards.png)

Однако Matter устроен немного более сложно чем Zigbee. К примеру он поддерживает в качестве транспорта как локальный Wi-Fi, так и low-power транспорт Thread. Так как для работы Matter over Wi-Fi не требуется никакого специального железа, то его поддержку можно реализовать софтварно, что и делает Home Assistant или всё таже Яндекс.Станция. Для Thread-устройств, как и для Zigbee, потребуется специальная железяка.

После исследования этой темой было принято решение, что нужно всё строить вокруг устойств на Zigbee и Matter. И если мы хотим чтобы HA напрямую управлял всем устройствами, то Zigbee-хаб в виде Яндекс.Станции не подойдёт, нужно что-то отдельное. Оказалось, это совсем не проблема. Встречаем [SONOFF Zigbee 3.0 USB Dongle Plus-E](https://www.sonoff.ru/product/stik-sonoff-zigbee-30-usb-dongle-plus-e).

![SONOFF Zigbee 3.0 USB Dongle Plus-E](https://static.insales-cdn.com/r/CfPxtdcLycc/rs:fit:1000:0:1/q:100/plain/images/products/1/1966/805037998/zzyi1zmqw2ssak7aflexciyiacugp7q2.jpg@webp)

Это USB-стик, который втыкается в устройство на котором запущен Home Assistant и позволяет ему делать всю работу. Более того, если очень захотеть, то стик можно перепрошить для поддержки Thread устройств. Но об этом позже.

# На чём будем хостить?

К счастью, ответ на этот вопрос искать не пришлось. 

![Synology DS720+](/ha/synology.png)

У нас уже есть Synology NAS, который выступает в качестве Media-сервера, качалки и бэкапилки. Помимо этого Synology позволяет запускать Docker-контейнеры и виртуальные машины. А раз можно Docker, то можно практически всё.

# Первый заход

Всё что потребовалось для первого запуска это:

1. Воткнуть Zigbee-стик в NAS
2. Немного [пошаманить с драйверами](https://github.com/robertklep/dsm7-usb-serial-drivers)
3. Запустить [HA в докере](https://www.home-assistant.io/installation/alternative#synology-nashttps://www.home-assistant.io/installation/alternative#synology-nas), прокинув ему Zigbee-стик как устройство

После этого через встроенную в HA поддержку Zigbee получилось добавить тот самый датчик освещения, а так же реле ( тоже [от Sonoff](https://www.ixbt.com/live/chome/sonoff-basiczbr3-byudzhetnoe-zigbee-rele-s-funkciey-routera-integraciya-v-home-assistant.html) ), которое управляет люстрой у входа. Оказалось, что в HA есть готовый сценарий для автоматизации - включать свет по движению:

![Сценарий включения света по движению](/ha/motion-activated-light.png)

Всё что нужно это выбрать датчик и лампочку.

Из интересного. Алиса не считают реле за "свет", для неё это кнопка. Поэтому нельзя использовать команды типа "включи свет". HA тоже по умолчанию видит устройство как кнопку, однако есть возможность поменять его тип. А точнее создать ещё одну сущность нужного типа. Делается это с помощью [хелпера](https://www.home-assistant.io/integrations/switch_as_x/):


![Превращаем выключатель в лампочку](/ha/change-type.png)

На этом этапе заработал первый полезный сценарий. Очень порадовала скорость работы - ведь теперь сигнал не идёт через сервера в других странах =) Попутно HA смог сам найти в домашней сети некоторые Wi-Fi устройства, в частности Yeelight-лампы, ими можно было управлять без каких либо аккаунтов. Часть других устройств - от LG и Samsung - получилось подключить благодаря готовым интеграциям, как и в Алисе.

Так же были проведены эксперименты с Zigbee-кнопкой, попробованы сценарии, которые срабатывают по времени или температуре. Оставалось понять как быть с голосовым управлением.

# Командуем через Алису

Команды голосом - не самая обязательная, но очень полезная часть умного дома. Включить свет когда заняты руки или запустить кондиционер не вставая с кровати - дорогого стоит. В Home Assistant есть поддержка голосовых помощников - Alexa или Google Assistant, через платное облако. Или же можно локально, даже с поддержкой русского языка ( не проверял насколько хорошо ), но потребуется устройство-микрофон. Однако у нас уже есть такие устройства в каждой команте - Яндекс.Станции, хотелось пока что переиспользовать их, даже если это будет требовать интернета. Немного поиска и вуаля, нашлись две чудесные интеграции - [YandexStation](https://github.com/AlexxIT/YandexStation) и [ha-yandex-station-intents](https://github.com/dext0r/ha-yandex-station-intents). Первая позволяет сконнектить HA и Умный дом Яндекса, а вторая поверх первой умеет заливать туда голосовые сценарии и генерировать события, которые затем запускают автоматизации. Работает это так. Сначала описываем фразы, на которые будет реагировать Алиса:

![Управляем светом](/ha/intents.png)

Интеграция загружает их в УДЯ:

![Загруженные сценарии](/ha/alice-phrases.png)

После чего можно создавать автоматизации. Можно даже определять какая из колонок и в какой комнате услышала команду:

![Срабатываем на фразу](/ha/light-automation.png)

Решение оказалось вполне себе рабочим, разве что неудобно писать кучи однообразных фраз и сценариев для каждого устройства и различных групп. Есть желание написать какую-то утилиту-генератор для этого дела. Ну и без интернета не работает, надо будет покопать тему микрофонов. Тогда можно будет смигрировать на туже [Ирину](https://github.com/janvarev/Irene-Voice-Assistant).

Голосовые команды заработали, основные сценарии проверены - пора переходить к полноценной миграции.

# Вперёд, к автономности

## Правильно ставим Home Assistant

Как я уже писал выше - HA можно расширять с помощью аддонов. Как выяснилось, официальные аддоны не поддерживаются в режиме установки через Docker-контейнер. Даже пункта меню такого в HA не появлятся. Чтобы их использовать нужно поставить HA в режиме операционной системы. Сделать это можно, к примеру, на Raspberry Pi. Ну или вместо контейнера запустить виртуальную машину. Это проще, такое наш Synology умеет. Для инструкции можно заглянуть в [тредик](https://community.home-assistant.io/t/installation-on-synology-virtual-machine-managager/281608). Делаем бэкап в докер-инсталляции, запускаем вируталку, импортируем бэкап. Не забываем прокинуть наш USB-стик в виртуалку. 

Теперь можно поставить такие аддоны к Web-терминал и File Editor для удобой работы с конфигами, а так же Nginx Proxy Manager для выставляения HA в интернет и Zigbee2MQTT для более продвинутой поддержки Zigbee.

## Меняем устройства

Самая дорогая часть - заменить все устройства требущие подключения к интернету. В нашем случае пришлось заменить 4 розетки и 2 лампочки. Были взяты новые [Matter-розетки от Яндекса](https://market.yandex.ru/product--yndx-00540/1914587012) ( уж очень дёшево они стоили ) и [Zigbee-лампочки от Aqara](https://market.yandex.ru/product--lampochka-aqara-light-bulb-t1-e27-8-5w-806lm-ledlbt1-l01/28251374).

![Новые устройства](/ha/devices.png)

Встроенная интеграция HA c Zigbee очень странно заработала с этими лампочками, включала на минимальной яркости, не реагировала на ползунки. Поэтому быстро перебрался на [Zigbee2MQTT](https://github.com/zigbee2mqtt/hassio-zigbee2mqtt), с которым всё заработало на ура. Розетки же завелись с полтычка через официальную Matter-интеграцию.

## Учим старые ходить локально

Менять пришлось не всё. Лампы от Yeelight уже работали локально, а лампочи Яндекса уделось переключить с помощью интеграции [Local Tuya](https://github.com/rospogrigio/localtuya). Процесс не самый простой, поэтому в будущем эти лампы первые кандидаты на замену. Так же как и светодиодная лента от TP-Link, которая заработало через [Tapo Controller](https://github.com/petretiandrea/home-assistant-tapo-p100).

# Немного про Matter

Как я уже писал выше - Matter может работать по разными транспортам. С WiFi всё просто, для Thread нужна железяка. Сначала я наткнулся на [инструкцию](https://dialedin.com.au/blog/sonoff-zbdongle-e-rcp-firmware) как прошить мой Zigbee-донгл, чтобы его можно было одновременно использовать и для Zigbee и для Matter. Сказано - сделано. Прошил, завёл всё в HA - работает. А потом оказалось, что иногда не работает - внезапно начали отваливаться Zigbee-устройства. Просто не срабатывают и всё. А через какое-то вермя - снова работают. Проблема лежала в том, что Thread хотел работать на одном канале, а Zigbee на другом. В попытках разобраться как всё это полечить выяснилось, что идея использования мульти-протокольных железок [подзагнулась](https://yellow.home-assistant.io/guides/about-multiprotocol/). А текущий рекомендованный подход - использовать раздельные железяки. Можно, к примеру, такой же SONOFF Zigbee 3.0 USB Dongle Plus-E прошить под Thread-only и он будет корректно работать.

К этому моменту я уже понял, что железок с Thread на рынке пока особо то и нету, поэтому он для меня не то чтобы и нужен. Поэтому вшил свежую Zigbee-only прошивку и с тех пор всё работает как часы. А если вдруг Thread таки потребуется - можно будет заиметь второй стик.

# Не забываем про бэкапы

Ну и напоследок, про то как не проиметь всё что так долго настраивалось =) Решение очевидно - нужно делать бэкапы. Желательно куда-то вовне, для надёжности. Очень простой вариант - настроить отправку в Google Drive с помощью [популярного аддона](https://github.com/sabeechen/hassio-google-drive-backup). Настройка элементарная, всё тут же начинает работать.

Однако, мы живём в неспокойные времена, Google Drive может и отвалиться. Поэтому исследую альтернативные варианты, к примеру складывать бэкапы в Яндекс.Диск или в S3-бакет. Можно посмотреть на чужие примеры - [раз](https://community.home-assistant.io/t/automated-nightly-backups-to-s3/506484), [два](https://community.home-assistant.io/t/backup-to-amazon-s3-addon/421395), [три](https://github.com/dral3x/ha-addons/tree/main/sync-backups-s3).

# А на сегодня всё

Вот теперь можно и закончить. В первую очередь это заметки для самого себя, чтобы не забыть. Но если кому-то вдруг оказалось полезно - очень хорошо.

До новых встреч =)